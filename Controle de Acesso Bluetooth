#include <SPI.h>
#include <MFRC522.h>
#include <Wire.h>
#include "BluetoothSerial.h"
#include <SSD1306Wire.h>

#if !defined(CONFIG_BT_ENABLED) || !defined(CONFIG_BLUEDROID_ENABLED)
#error Bluetooth is not enabled! Please run make menuconfig to and enable it
#endif

// Definições dos pinos
#define SS_PIN 5
#define RST_PIN 4
#define SCK_PIN 18
#define MOSI_PIN 23
#define MISO_PIN 19

#define OLED_SDA 21
#define OLED_SCL 22
#define SCREEN_WIDTH 128
#define SCREEN_HEIGHT 64

// Objetos
MFRC522 mfrc522(SS_PIN, RST_PIN);
SSD1306Wire display(0x3c, OLED_SDA, OLED_SCL);
BluetoothSerial SerialBT;

// Estrutura para armazenar dados do usuário
struct Usuario {
  String id;
  String nome;
  bool presente;
  unsigned long entrada;
  unsigned long tempoPermanencia; // Tempo da permanência atual (será resetado)
  unsigned long tempoTotal;       // Tempo total acumulado (não será resetado)
};

// Variáveis globais
const int MAX_USUARIOS = 20;
Usuario usuarios[MAX_USUARIOS];
int totalUsuarios = 0;
bool aguardandoNome = false;
String idAguardandoNome = "";
String nomeRecebido = "";

// Variáveis para controle do relatório
bool mostrandoRelatorio = false;
unsigned long tempoInicioRelatorio = 0;
const unsigned long TEMPO_RELATORIO_MS = 10000; // 10 segundos
bool relatorioMostrado = false; // Para controlar se o relatório já foi mostrado

void setup() {
  Serial.begin(115200);
  
  // Inicializar SPI
  SPI.begin(SCK_PIN, MISO_PIN, MOSI_PIN, SS_PIN);
  
  // Inicializar RFID
  mfrc522.PCD_Init();
  
  // Inicializar OLED
  display.init();
  display.flipScreenVertically();
  display.setFont(ArialMT_Plain_10);
  
  // Inicializar Bluetooth
  SerialBT.begin("ESP32_Controle_Acesso");
  
  // Mensagem inicial no OLED
  mostrarTelaNormal();
  
  SerialBT.println("Sistema de Controle de Acesso Iniciado");
  SerialBT.println("Aguardando comandos...");
}

void loop() {
  // Verificar se há dados do Bluetooth
  if (SerialBT.available()) {
    String mensagem = SerialBT.readString();
    mensagem.trim(); 
    
    if (aguardandoNome) {
      nomeRecebido = mensagem;
      cadastrarNovoUsuario(idAguardandoNome, nomeRecebido);
      aguardandoNome = false;
      idAguardandoNome = "";
      nomeRecebido = "";
    } else {
      processarComandoBluetooth(mensagem);
    }
  }
  
  // Verificar se há cartão RFID presente
  if (mfrc522.PICC_IsNewCardPresent() && mfrc522.PICC_ReadCardSerial()) {
    String id = lerIDRFID();
    
    // Verificar se é um usuário conhecido
    int indice = buscarUsuarioPorID(id);
    
    if (indice == -1) {
      // Novo usuário - solicitar cadastro
      SerialBT.println("Novo usuario detectado! ID: " + id);
      SerialBT.println("Por favor, digite o nome para cadastro:");
      idAguardandoNome = id;
      aguardandoNome = true;
      
      mostrarTelaNovoUsuario(id);
    } else {
      // Usuário existente - registrar entrada/saída
      registrarMovimento(indice);
    }
    
    mfrc522.PICC_HaltA();
    delay(1000);
  }
  
  // Verificar se todos saíram E se há usuários cadastrados E se o relatório ainda não foi mostrado
  if (todosSairam() && totalUsuarios > 0 && !mostrandoRelatorio && !relatorioMostrado) {
    mostrarRelatorioOLED();
    mostrandoRelatorio = true;
    relatorioMostrado = true; // Marca que o relatório já foi mostrado
    tempoInicioRelatorio = millis();
  }
  
  // Verificar se já passou o tempo do relatório
  if (mostrandoRelatorio && (millis() - tempoInicioRelatorio > TEMPO_RELATORIO_MS)) {
    mostrandoRelatorio = false;
    mostrarTelaNormal();
  }
  
  // Resetar a flag relatorioMostrado quando alguém entrar
  if (!todosSairam() && relatorioMostrado) {
    relatorioMostrado = false;
  }
  
  delay(100);
}

void mostrarTelaNormal() {
  display.clear();
  display.setTextAlignment(TEXT_ALIGN_LEFT);
  display.drawString(0, 0, "Sistema Ativo");
  display.drawString(0, 12, "Aproxime o cartao");
  display.drawString(0, 24, "Usuarios: " + String(totalUsuarios));
  display.display();
}

void mostrarTelaNovoUsuario(String id) {
  display.clear();
  display.drawString(0, 0, "NOVO USUARIO");
  display.drawString(0, 12, "ID: " + id);
  display.drawString(0, 24, "Cadastre via BT");
  display.display();
}

String lerIDRFID() {
  String id = "";
  for (byte i = 0; i < mfrc522.uid.size; i++) {
    id.concat(String(mfrc522.uid.uidByte[i] < 0x10 ? "0" : ""));
    id.concat(String(mfrc522.uid.uidByte[i], HEX));
  }
  id.toUpperCase();
  return id;
}

int buscarUsuarioPorID(String id) {
  for (int i = 0; i < totalUsuarios; i++) {
    if (usuarios[i].id == id) {
      return i;
    }
  }
  return -1;
}

void cadastrarNovoUsuario(String id, String nome) {
  if (totalUsuarios < MAX_USUARIOS) {
    usuarios[totalUsuarios].id = id;
    usuarios[totalUsuarios].nome = nome;
    usuarios[totalUsuarios].presente = true;
    usuarios[totalUsuarios].entrada = millis();
    usuarios[totalUsuarios].tempoPermanencia = 0;
    usuarios[totalUsuarios].tempoTotal = 0;
    
    SerialBT.println("Usuario cadastrado com sucesso!");
    SerialBT.println("Nome: " + nome);
    SerialBT.println("ID: " + id);
    
    mostrarTelaCadastrado(nome);
    totalUsuarios++;
    mostrarStatusBluetooth();
    delay(2000);
    mostrarTelaNormal();
    
    // Resetar flag do relatório quando novo usuário entrar
    relatorioMostrado = false;
  } else {
    SerialBT.println("Erro: Limite maximo de usuarios atingido!");
  }
}

void mostrarTelaCadastrado(String nome) {
  display.clear();
  display.drawString(0, 0, "CADASTRADO!");
  display.drawString(0, 12, "Nome: " + nome);
  display.drawString(0, 24, "Bem-vindo!");
  display.display();
}

void registrarMovimento(int indice) {
  if (usuarios[indice].presente) {
    // Registrar saída - calcular tempo desta permanência
    unsigned long tempoEstaPermanencia = millis() - usuarios[indice].entrada;
    
    // Adicionar ao tempo total acumulado
    usuarios[indice].tempoTotal += tempoEstaPermanencia;
    
    // Resetar tempoPermanencia para a próxima entrada
    usuarios[indice].tempoPermanencia = 0;
    usuarios[indice].presente = false;
    
    SerialBT.println("SAIDA: " + usuarios[indice].nome);
    SerialBT.println("Tempo desta permanencia: " + formatarTempo(tempoEstaPermanencia));
    SerialBT.println("Tempo total acumulado: " + formatarTempo(usuarios[indice].tempoTotal));
    
    mostrarTelaSaida(usuarios[indice].nome, tempoEstaPermanencia, usuarios[indice].tempoTotal);
  } else {
    // Registrar entrada
    usuarios[indice].presente = true;
    usuarios[indice].entrada = millis();
    
    SerialBT.println("ENTRADA: " + usuarios[indice].nome);
    SerialBT.println("Tempo total acumulado: " + formatarTempo(usuarios[indice].tempoTotal));
    
    mostrarTelaEntrada(usuarios[indice].nome, usuarios[indice].tempoTotal);
    
    // Resetar flag do relatório quando alguém entrar
    relatorioMostrado = false;
  }
  
  delay(2000);
  
  // Só mostra status se não estiver mostrando relatório
  if (!mostrandoRelatorio) {
    mostrarStatusBluetooth();
    mostrarTelaNormal();
  }
}

void mostrarTelaSaida(String nome, unsigned long tempoEstaPermanencia, unsigned long tempoTotal) {
  display.clear();
  display.drawString(0, 0, "SAIDA REGISTRADA");
  display.drawString(0, 12, "Nome: " + nome);
  display.drawString(0, 24, "Esta: " + formatarTempo(tempoEstaPermanencia));
  display.drawString(0, 36, "Total: " + formatarTempo(tempoTotal));
  display.display();
}

void mostrarTelaEntrada(String nome, unsigned long tempoTotal) {
  display.clear();
  display.drawString(0, 0, "ENTRADA");
  display.drawString(0, 12, "Bem-vindo!");
  display.drawString(0, 24, nome);
  display.drawString(0, 36, "Total: " + formatarTempo(tempoTotal));
  display.display();
}

bool todosSairam() {
  for (int i = 0; i < totalUsuarios; i++) {
    if (usuarios[i].presente) {
      return false;
    }
  }
  return true;
}

void mostrarRelatorioOLED() {
  display.clear();
  display.setFont(ArialMT_Plain_10);
  display.setTextAlignment(TEXT_ALIGN_LEFT);
  display.drawString(0, 0, "RELATORIO FINAL");
  display.drawString(0, 12, "TOTAL ACUMULADO");
  display.drawString(0, 24, "----------------");
  
  int linha = 36;
  for (int i = 0; i < totalUsuarios && linha < SCREEN_HEIGHT - 8; i++) {
    String linhaTexto = usuarios[i].nome.substring(0, 8) + ":";
    linhaTexto += formatarTempo(usuarios[i].tempoTotal);
    
    display.drawString(0, linha, linhaTexto);
    linha += 10;
  }
  
  display.display();
  
  // Também enviar relatório via Bluetooth
  SerialBT.println("\n--- RELATORIO FINAL ---");
  SerialBT.println("TEMPO TOTAL ACUMULADO");
  for (int i = 0; i < totalUsuarios; i++) {
    String tempoTotal = formatarTempo(usuarios[i].tempoTotal);
    SerialBT.println(usuarios[i].nome + ": " + tempoTotal);
  }
  SerialBT.println("---------------------\n");
}

void mostrarStatusBluetooth() {
  SerialBT.println("\n--- STATUS ATUAL ---");
  int presentes = 0;
  
  for (int i = 0; i < totalUsuarios; i++) {
    String status = usuarios[i].presente ? "PRESENTE" : "AUSENTE";
    String tempoInfo = usuarios[i].presente ? 
      " (Tempo atual: " + formatarTempo(millis() - usuarios[i].entrada) + ")" :
      " (Total: " + formatarTempo(usuarios[i].tempoTotal) + ")";
    
    SerialBT.println(usuarios[i].nome + ": " + status + tempoInfo);
    if (usuarios[i].presente) presentes++;
  }
  
  SerialBT.println("Total presentes: " + String(presentes));
  SerialBT.println("---------------------\n");
}

String formatarTempo(unsigned long milliseconds) {
  unsigned long segundos = milliseconds / 1000;
  unsigned long minutos = segundos / 60;
  unsigned long horas = minutos / 60;
  
  segundos = segundos % 60;
  minutos = minutos % 60;
  
  char buffer[20];
  if (horas > 0) {
    snprintf(buffer, sizeof(buffer), "%02lu:%02lu:%02lu", horas, minutos, segundos);
  } else {
    snprintf(buffer, sizeof(buffer), "%02lu:%02lu", minutos, segundos);
  }
  
  return String(buffer);
}

void processarComandoBluetooth(String comando) {
  comando.toUpperCase();
  
  if (comando == "STATUS") {
    mostrarStatusBluetooth();
  } else if (comando == "LISTA") {
    SerialBT.println("\n=== LISTA DE USUARIOS ===");
    for (int i = 0; i < totalUsuarios; i++) {
      SerialBT.println(String(i+1) + ". " + usuarios[i].nome + 
                      " (ID: " + usuarios[i].id + 
                      ", Total: " + formatarTempo(usuarios[i].tempoTotal) + ")");
    }
    SerialBT.println("---------------------\n");
  } else if (comando == "RELATORIO") {
    SerialBT.println("\n--- RELATORIO DETALHADO ---");
    for (int i = 0; i < totalUsuarios; i++) {
      String tempoTotal = formatarTempo(usuarios[i].tempoTotal);
      SerialBT.println(usuarios[i].nome + ": " + tempoTotal);
    }
    SerialBT.println("---------------------\n");
  } else if (comando == "AJUDA" || comando == "HELP") {
    SerialBT.println("\n--- COMANDOS DISPONIVEIS ---");
    SerialBT.println("STATUS - Mostrar status atual");
    SerialBT.println("LISTA - Listar todos usuarios");
    SerialBT.println("RELATORIO - Mostrar tempos totais");
    SerialBT.println("AJUDA - Mostrar esta ajuda");
    SerialBT.println("---------------------\n");
  } else {
    SerialBT.println("Comando nao reconhecido. Digite AJUDA para ver os comandos.");
  }
}
